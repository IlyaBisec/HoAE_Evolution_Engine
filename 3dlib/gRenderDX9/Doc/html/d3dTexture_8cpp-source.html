<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>gRenderDX9: d3dTexture.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.1 -->
<h1>d3dTexture.cpp</h1><div class="fragment"><pre>00001 <span class="comment">/*****************************************************************************/</span>
00002 <span class="comment">/*  File:   d3dTexture.cpp</span>
00003 <span class="comment">/*  Desc:   Texture interface implementation for DirectX9 </span>
00004 <span class="comment">/*  Author: Ruslan Shestopalyuk</span>
00005 <span class="comment">/*  Date:   02.11.2004</span>
00006 <span class="comment">/*****************************************************************************/</span>
00007 <span class="preprocessor">#include "gRenderPch.h"</span>
00008 <span class="preprocessor">#include "d3dTexture.h"</span>
00009 <span class="preprocessor">#include "d3dAdapt.h"</span>
00010 <span class="preprocessor">#include "direct.h"</span>
00011 <span class="keyword">extern</span> <span class="keywordtype">int</span> OtherTime;
00012 <span class="comment">/*****************************************************************************/</span>
00013 <span class="comment">/*  TextureDX9 implementation</span>
00014 <span class="comment">/*****************************************************************************/</span>
00015 TextureDX9::TextureDX9( IDirect3DDevice9* pDevice )
00016 {
00017     m_pDevice           = pDevice;       
00018     m_pTexture          = NULL;
00019     m_pCubeTexture      = NULL;  
00020     m_pVolTexture       = NULL;   
00021     m_pZBuffer          = NULL;      
00022 
00023     m_pBaseTexture      = NULL;  
00024 
00025     m_Name              = <span class="stringliteral">""</span>;
00026     m_Type              = tt2D;
00027     m_NMipMaps          = 0;
00028     m_MemoryPool        = tmpManaged;
00029     m_ColorFormat       = cfUnknown;
00030     m_Width             = 0;
00031     m_Height            = 0;
00032 
00033     m_bRenderTarget     = <span class="keyword">false</span>;
00034     m_DSFormat          = dsfNone;
00035     m_bNoTexture        = <span class="keyword">false</span>;
00036 
00037 } <span class="comment">// TextureDX9::TextureDX9</span>
00038 
00039 TextureDX9::TextureDX9()
00040 {
00041     m_pDevice           = NULL;       
00042     m_pTexture          = NULL;
00043     m_pCubeTexture      = NULL;  
00044     m_pVolTexture       = NULL;   
00045     m_pZBuffer          = NULL;      
00046 
00047     m_pBaseTexture      = NULL;  
00048 
00049     m_Name              = <span class="stringliteral">""</span>;
00050     m_Type              = tt2D;
00051     m_NMipMaps          = 0;
00052     m_MemoryPool        = tmpManaged;
00053     m_ColorFormat       = cfUnknown;
00054     m_Width             = 0;
00055     m_Height            = 0;
00056 
00057     m_bRenderTarget     = <span class="keyword">false</span>;
00058     m_DSFormat          = dsfNone;
00059     m_bNoTexture        = <span class="keyword">false</span>;
00060 } <span class="comment">// TextureDX9::TextureDX9</span>
00061 
00062 TextureDX9::~TextureDX9()
00063 {
00064 } <span class="comment">// TextureDX9::~TextureDX9</span>
00065 
00066 <span class="keywordtype">void</span> TextureDX9::InvalidateDeviceObjects()
00067 {
00068     <span class="keywordflow">if</span> (m_MemoryPool != tmpManaged)
00069     {
00070         SAFE_RELEASE( m_pTexture        );
00071         SAFE_RELEASE( m_pCubeTexture    );
00072         SAFE_RELEASE( m_pVolTexture     );
00073         SAFE_RELEASE( m_pZBuffer        );
00074 
00075         m_pTexture       = NULL;
00076         m_pCubeTexture   = NULL;    
00077         m_pVolTexture    = NULL; 
00078         m_pZBuffer       = NULL;    
00079 
00080         m_pBaseTexture   = NULL;    
00081     }
00082 } <span class="comment">// TextureDX9::InvalidateDeviceObjects</span>
00083 
00084 <span class="keywordtype">void</span> TextureDX9::RestoreDeviceObjects() 
00085 {
00086     <span class="keywordflow">if</span> (m_MemoryPool != tmpManaged) Create();
00087 } <span class="comment">// TextureDX9::RestoreDeviceObjects</span>
00088 
00089 IDirect3DSurface9* TextureDX9::GetSurface( <span class="keywordtype">int</span> idx )
00090 {
00091     <span class="keywordflow">if</span> (m_pZBuffer) <span class="keywordflow">return</span> m_pZBuffer;
00092     IDirect3DSurface9* pSurf = NULL;
00093     <span class="keywordflow">if</span> (m_pTexture)
00094     {
00095         <span class="keywordtype">int</span> nRef = GetRefCount( m_pTexture );
00096         DX_CHK( m_pTexture-&gt;GetSurfaceLevel( idx, &amp;pSurf ) );
00097     }
00098     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_pCubeTexture)
00099     {
00100         DX_CHK( m_pCubeTexture-&gt;GetCubeMapSurface( (D3DCUBEMAP_FACES)(idx%6), idx/6, &amp;pSurf ) );
00101     }
00102     <span class="keywordflow">return</span> pSurf;
00103 } <span class="comment">// TextureDX9::GetSurface</span>
00104 
00105 <span class="keywordtype">void</span> TextureDX9::DeleteDeviceObjects()
00106 {
00107     SAFE_RELEASE( m_pTexture        );
00108     SAFE_RELEASE( m_pCubeTexture    );
00109     SAFE_RELEASE( m_pVolTexture     );
00110     SAFE_RELEASE( m_pZBuffer        );
00111 
00112     m_pTexture       = NULL;
00113     m_pCubeTexture   = NULL;    
00114     m_pVolTexture    = NULL; 
00115     m_pZBuffer       = NULL;    
00116 
00117     m_pBaseTexture   = NULL;    
00118 } <span class="comment">// TextureDX9::ReleaseDeviceResources</span>
00119 <span class="keywordtype">int</span> SetTextureTime=0;
00120 <span class="keywordtype">void</span> TextureDX9::Bind( <span class="keywordtype">int</span> stage )
00121 {
00122     <span class="keywordflow">if</span> (!m_pBaseTexture)
00123     {
00124         Load();
00125     }
00126     __beginT();
00127     DX_CHK( m_pDevice-&gt;SetTexture( stage, m_pBaseTexture ) );
00128     __endT(SetTextureTime);
00129 } <span class="comment">// TextureDX9::Bind</span>
00130 
00131 <span class="keywordtype">bool</span> TextureDX9::SaveToFile( <span class="keyword">const</span> <span class="keywordtype">char</span>* fName )<span class="keyword"> const</span>
00132 <span class="keyword"></span>{
00133     <span class="keywordflow">if</span> (!m_pTexture) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00134     <span class="keywordtype">void</span> ParseExtension( <span class="keyword">const</span> <span class="keywordtype">char</span>* fname, <span class="keywordtype">char</span>* ext );
00135     <span class="keywordtype">char</span> ext[64];
00136     ParseExtension( fName, ext );
00137 
00138     D3DXIMAGE_FILEFORMAT type = D3DXIFF_DDS;
00139 
00140     <span class="keywordflow">if</span> (!strcmp( ext, <span class="stringliteral">"bmp"</span> )) type = D3DXIFF_BMP;
00141     <span class="keywordflow">if</span> (!strcmp( ext, <span class="stringliteral">"tga"</span> )) type = D3DXIFF_TGA;
00142     <span class="keywordflow">if</span> (!strcmp( ext, <span class="stringliteral">"dds"</span> )) type = D3DXIFF_DDS;
00143 
00144     HRESULT hRes = D3DXSaveTextureToFile( fName, type, m_pBaseTexture, 0 );
00145     <span class="keywordflow">return</span> (hRes == S_OK);
00146 } <span class="comment">// TextureDX9::SaveToFile</span>
00147 
00148 BYTE* TextureDX9::LockBits( <span class="keywordtype">int</span>&amp; pitch, <span class="keywordtype">int</span> level )
00149 {
00150     <span class="keywordflow">if</span> (!m_pBaseTexture)
00151     {
00152         Load();
00153     }
00154     <span class="keywordflow">if</span> (!m_pTexture) <span class="keywordflow">return</span> NULL;
00155     D3DLOCKED_RECT rct;
00156     DX_CHK( m_pTexture-&gt;LockRect( level, &amp;rct, 0, 0 ) );
00157     pitch = rct.Pitch;
00158     <span class="keywordflow">return</span> (BYTE*)(rct.pBits);
00159 } <span class="comment">// TextureDX9::LockBits</span>
00160 
00161 BYTE* TextureDX9::LockBits( <span class="keywordtype">int</span>&amp; pitch, <span class="keyword">const</span> Rct&amp; rect, <span class="keywordtype">int</span> level )<span class="keyword"> const</span>
00162 <span class="keyword"></span>{
00163     <span class="keywordflow">if</span> (!m_pTexture) <span class="keywordflow">return</span> NULL;
00164     RECT rc;
00165     rc.left     = rect.x;
00166     rc.top      = rect.y;
00167     rc.right    = rect.GetRight();
00168     rc.bottom   = rect.GetBottom();
00169 
00170     D3DLOCKED_RECT d3dRect;
00171     __beginT();
00172     DX_CHK( m_pTexture-&gt;LockRect( level, &amp;d3dRect, &amp;rc, 0 ) );
00173     __endT(OtherTime);
00174     pitch = d3dRect.Pitch;
00175     <span class="keywordflow">return</span> (BYTE*)(d3dRect.pBits);
00176 } <span class="comment">// TextureDX9::LockBits</span>
00177 
00178 <span class="keywordtype">void</span> TextureDX9::UnlockBits( <span class="keywordtype">int</span> level )<span class="keyword"> const</span>
00179 <span class="keyword"></span>{
00180     <span class="keywordflow">if</span> (!m_pTexture) <span class="keywordflow">return</span>;
00181     __beginT();
00182     m_pTexture-&gt;UnlockRect( level );
00183     __endT(OtherTime);
00184 } <span class="comment">// TextureDX9::UnlockBits</span>
00185 
00186 <span class="keywordtype">bool</span> TextureDX9::Create(    <span class="keywordtype">int</span>                 width, 
00187                             <span class="keywordtype">int</span>                 height, 
00188                             ColorFormat         clrFormat, 
00189                             <span class="keywordtype">int</span>                 nMips, 
00190                             TextureMemoryPool   memPool, 
00191                             <span class="keywordtype">bool</span>                bRenderTarget, 
00192                             DepthStencilFormat  dsFormat, 
00193                             <span class="keywordtype">bool</span>                bDynamic )
00194 {
00195     m_Type          = tt2D;          
00196     m_NMipMaps      = nMips;      
00197     m_MemoryPool    = memPool;    
00198     m_ColorFormat   = clrFormat;   
00199     m_Width         = width;         
00200     m_Height        = height;
00201 
00202     m_bRenderTarget = bRenderTarget;
00203     m_DSFormat      = dsFormat;
00204     m_bDynamic      = bDynamic;
00205     <span class="keywordflow">return</span> Create();
00206 } <span class="comment">// TextureDX9::Create</span>
00207 
00208 <span class="keywordtype">bool</span> TextureDX9::Create()
00209 {
00210     DeleteDeviceObjects();
00211     <span class="keywordflow">if</span> (!m_pDevice) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00212     HRESULT result = S_OK;
00213     <span class="keywordflow">if</span> (m_DSFormat != dsfNone)
00214     {
00215         result = m_pDevice-&gt;CreateDepthStencilSurface(  m_Width, m_Height, 
00216                                 ConvertDepthStencilFormat( m_DSFormat ), 
00217                                 D3DMULTISAMPLE_NONE, 0, TRUE, &amp;m_pZBuffer, NULL );
00218     }
00219     <span class="keywordflow">else</span>
00220     {
00221         DWORD usage = 0;
00222         <span class="keywordflow">if</span> (m_bRenderTarget) 
00223         {
00224             usage |= D3DUSAGE_RENDERTARGET;
00225         }
00226         <span class="keywordflow">if</span> (m_bDynamic) usage |= D3DUSAGE_DYNAMIC;
00227         result = D3DXCreateTexture( m_pDevice, m_Width, m_Height, m_NMipMaps, usage,            
00228                                     ConvertColorFormat( m_ColorFormat ), 
00229                                     ConvertMemoryPool( m_MemoryPool ), 
00230                                     &amp;m_pTexture );
00231     }
00232 
00233     <span class="keywordflow">if</span> (result == D3DERR_OUTOFVIDEOMEMORY)
00234     {
00235         Log.Error( <span class="stringliteral">"Not enough video memory to create texture: %s(%dx%d)"</span>, 
00236                         m_Name.c_str(), m_Width, m_Height );
00237         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00238     }
00239     <span class="keywordflow">if</span> (!m_pTexture &amp;&amp; !m_pZBuffer) <span class="keywordflow">return</span> -1;
00240 
00241     m_pBaseTexture  = m_pTexture;
00242 
00243     <span class="comment">//  declare whole texture as 'dirty'</span>
00244     RECT rc;
00245     rc.left   = 0;
00246     rc.top    = 0;
00247     rc.right  = m_Width;
00248     rc.bottom = m_Height;
00249     <span class="keywordflow">if</span> (m_pTexture) m_pTexture-&gt;AddDirtyRect( &amp;rc );
00250 
00251     DX_CHK( result );
00252     <span class="keywordflow">return</span> (result == S_OK);
00253 } <span class="comment">// TextureDX9::Create</span>
00254 
00255 <span class="keywordtype">bool</span> TextureDX9::Reload() 
00256 {
00257     DeleteDeviceObjects();
00258     <span class="keywordflow">return</span> Load();
00259 } <span class="comment">// TextureDX9::Reload</span>
00260 
00261 ColorFormat TextureDX9::GetColorFormat() 
00262 { 
00263     <span class="keywordflow">if</span> (m_pBaseTexture) Load(); 
00264     <span class="keywordflow">return</span> m_ColorFormat; 
00265 } <span class="comment">// TextureDX9::GetColorFormat</span>
00266 
00267 <span class="keywordtype">bool</span> TextureDX9::Load() 
00268 {
00269     <span class="keywordflow">if</span> (m_bNoTexture) <span class="keywordflow">return</span> <span class="keyword">false</span>;
00270     FilePath path;
00271     path.GetCWD();
00272     _chdir( m_SearchPath.c_str() );
00273     <span class="keywordtype">int</span> size = 0;
00274     FilePath tpath( m_Name.c_str() );
00275     <span class="keywordtype">int</span> resID = IRM-&gt;FindResource( tpath.GetFullPath() );
00276     <span class="keywordflow">if</span> (resID == -1) 
00277     {
00278         tpath.SetExt( <span class="stringliteral">"dds"</span> );
00279         resID = IRM-&gt;FindResource( tpath.GetFullPath() );
00280     }
00281     <span class="keywordflow">if</span> (resID == -1) 
00282     {
00283         tpath.SetExt( <span class="stringliteral">"tga"</span> );
00284         resID = IRM-&gt;FindResource( tpath.GetFullPath() );
00285     }
00286     <span class="keywordflow">if</span> (resID == -1) 
00287     {
00288         tpath.SetExt( <span class="stringliteral">"jpg"</span> );
00289         resID = IRM-&gt;FindResource( tpath.GetFullPath() );
00290     }
00291     <span class="keywordflow">if</span> (resID == -1) 
00292     {
00293         tpath.SetExt( <span class="stringliteral">"bmp"</span> );
00294         resID = IRM-&gt;FindResource( tpath.GetFullPath() );
00295     }
00296     <span class="keywordflow">if</span> (resID == -1) 
00297     {
00298         Log.Warning( <span class="stringliteral">"Could not load texture &lt;%s&gt;"</span>, tpath.GetFullPath() );
00299         m_bNoTexture = <span class="keyword">true</span>;
00300         <span class="keywordflow">return</span> <span class="keyword">false</span>; 
00301     }
00302 
00303     IRM-&gt;BindResource( resID, <span class="keyword">this</span> );
00304     BYTE* pData = IRM-&gt;LockData( resID, size );
00305     <span class="keywordtype">bool</span> res = LoadFromMemory( pData, size );
00306     IRM-&gt;UnlockData( resID );
00307     path.SetCWD();
00308     <span class="keywordflow">return</span> res;
00309 } <span class="comment">// TextureDX9::Load</span>
00310 
00311 <span class="keywordtype">bool</span> TextureDX9::LoadFromFile( <span class="keyword">const</span> <span class="keywordtype">char</span>* fName )
00312 {
00313     FilePath path;
00314     path.GetCWD();
00315     _chdir( m_SearchPath.c_str() );
00316 
00317     HRESULT hres = S_OK;
00318 
00319     D3DXIMAGE_INFO info;
00320     hres = D3DXGetImageInfoFromFile( fName, &amp;info );
00321 
00322     <span class="keywordflow">if</span> (info.ResourceType == D3DRTYPE_TEXTURE)
00323     {
00324         m_Type = tt2D;
00325         hres = D3DXCreateTextureFromFileEx( m_pDevice, 
00326                                             fName,                  <span class="comment">//  file name</span>
00327                                             D3DX_DEFAULT,           <span class="comment">//  width</span>
00328                                             D3DX_DEFAULT,           <span class="comment">//  height</span>
00329                                             D3DX_DEFAULT,           <span class="comment">//  number of mip levels</span>
00330                                             0,                      <span class="comment">//  texture usage</span>
00331                                             D3DFMT_UNKNOWN,         <span class="comment">//  color format</span>
00332                                             D3DPOOL_MANAGED,        <span class="comment">//  memory pool</span>
00333                                             D3DX_DEFAULT,           <span class="comment">//  image filter </span>
00334                                             D3DX_DEFAULT,           <span class="comment">//  mip filter</span>
00335                                             0,                      <span class="comment">//  disable color key</span>
00336                                             NULL,                   <span class="comment">//  don't care about image info</span>
00337                                             NULL,                   <span class="comment">//  no palette</span>
00338                                             &amp;m_pTexture             
00339                                         );
00340         m_pBaseTexture  = m_pTexture;
00341     }
00342     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.ResourceType == D3DRTYPE_VOLUMETEXTURE)
00343     {
00344          m_Type = tt3D;
00345          hres = D3DXCreateVolumeTextureFromFileEx(  m_pDevice, 
00346                                                     fName,                  <span class="comment">//  file name</span>
00347                                                     D3DX_DEFAULT,           <span class="comment">//  width</span>
00348                                                     D3DX_DEFAULT,           <span class="comment">//  height</span>
00349                                                     D3DX_DEFAULT,           <span class="comment">//  depth</span>
00350                                                     D3DX_DEFAULT,           <span class="comment">//  number of mip levels</span>
00351                                                     0,                      <span class="comment">//  texture usage</span>
00352                                                     D3DFMT_UNKNOWN,         <span class="comment">//  color format</span>
00353                                                     D3DPOOL_MANAGED,        <span class="comment">//  memory pool</span>
00354                                                     D3DX_DEFAULT,           <span class="comment">//  image filter </span>
00355                                                     D3DX_DEFAULT,           <span class="comment">//  mip filter</span>
00356                                                     0,                      <span class="comment">//  disable color key</span>
00357                                                     NULL,                   <span class="comment">//  don't care about image info</span>
00358                                                     NULL,                   <span class="comment">//  no palette</span>
00359                                                     &amp;m_pVolTexture              
00360                                                     );
00361          m_pBaseTexture  = m_pVolTexture;
00362     }
00363     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.ResourceType == D3DRTYPE_CUBETEXTURE)
00364     {
00365         m_Type = ttCubeMap;
00366         hres = D3DXCreateCubeTextureFromFileEx( m_pDevice, 
00367                                                 fName,                  <span class="comment">//  file name</span>
00368                                                 D3DX_DEFAULT,           <span class="comment">//  width</span>
00369                                                 D3DX_DEFAULT,           <span class="comment">//  number of mip levels</span>
00370                                                 0,                      <span class="comment">//  texture usage</span>
00371                                                 D3DFMT_UNKNOWN,         <span class="comment">//  color format</span>
00372                                                 D3DPOOL_MANAGED,        <span class="comment">//  memory pool</span>
00373                                                 D3DX_DEFAULT,           <span class="comment">//  image filter </span>
00374                                                 D3DX_DEFAULT,           <span class="comment">//  mip filter</span>
00375                                                 0,                      <span class="comment">//  disable color key</span>
00376                                                 NULL,                   <span class="comment">//  don't care about image info</span>
00377                                                 NULL,                   <span class="comment">//  no palette</span>
00378                                                 &amp;m_pCubeTexture             
00379                                                 );
00380         m_pBaseTexture  = m_pCubeTexture;    
00381     }
00382 
00383     path.SetCWD();
00384 
00385     <span class="keywordflow">if</span> (hres != S_OK || !m_pTexture)
00386     {
00387         Log.Warning( <span class="stringliteral">"Couldn't load texture &lt;%s&gt;"</span>, fName );
00388         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00389     }
00390     
00391     <span class="comment">//  get info into texture description</span>
00392     D3DSURFACE_DESC sdesc;
00393     DX_CHK( m_pTexture-&gt;GetLevelDesc( 0, &amp;sdesc ) );
00394     
00395     m_Type          = tt2D;
00396     m_NMipMaps      = m_pTexture-&gt;GetLevelCount();
00397     m_MemoryPool    = ConvertMemoryPool( sdesc.Pool );
00398     m_ColorFormat   = ConvertColorFormat( sdesc.Format );
00399     m_Width         = sdesc.Width;
00400     m_Height        = sdesc.Height;
00401     m_DSFormat      = dsfNone;
00402     m_bRenderTarget = <span class="keyword">false</span>;
00403     
00404     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00405 } <span class="comment">// TextureDX9::LoadFromFile</span>
00406 
00407 <span class="keywordtype">bool</span> TextureDX9::LoadFromMemory( <span class="keyword">const</span> BYTE* pBuf, <span class="keywordtype">int</span> nBytes )
00408 {
00409     HRESULT hres = S_OK;
00410     D3DXIMAGE_INFO info;
00411     hres = D3DXGetImageInfoFromFileInMemory( pBuf, nBytes, &amp;info );
00412 
00413     <span class="keywordflow">if</span> (info.ResourceType == D3DRTYPE_TEXTURE)
00414     {
00415         m_Type = tt2D;
00416         hres = D3DXCreateTextureFromFileInMemoryEx( m_pDevice, 
00417                                                     pBuf, nBytes,
00418                                                     D3DX_DEFAULT,           <span class="comment">//  width</span>
00419                                                     D3DX_DEFAULT,           <span class="comment">//  height</span>
00420                                                     D3DX_DEFAULT,           <span class="comment">//  number of mip levels</span>
00421                                                     0,                      <span class="comment">//  texture usage</span>
00422                                                     D3DFMT_UNKNOWN,         <span class="comment">//  color format</span>
00423                                                     D3DPOOL_MANAGED,        <span class="comment">//  memory pool</span>
00424                                                     D3DX_DEFAULT,           <span class="comment">//  image filter </span>
00425                                                     D3DX_DEFAULT,           <span class="comment">//  mip filter</span>
00426                                                     0,                      <span class="comment">//  disable color key</span>
00427                                                     NULL,                   <span class="comment">//  don't care about image info</span>
00428                                                     NULL,                   <span class="comment">//  no palette</span>
00429                                                     &amp;m_pTexture             
00430                                                     );
00431         m_pBaseTexture  = m_pTexture;
00432     }
00433     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.ResourceType == D3DRTYPE_VOLUMETEXTURE)
00434     {
00435         m_Type = tt3D;
00436         hres = D3DXCreateVolumeTextureFromFileInMemoryEx(   m_pDevice, 
00437                                                             pBuf, nBytes,
00438                                                             D3DX_DEFAULT,           <span class="comment">//  width</span>
00439                                                             D3DX_DEFAULT,           <span class="comment">//  height</span>
00440                                                             D3DX_DEFAULT,           <span class="comment">//  depth</span>
00441                                                             D3DX_DEFAULT,           <span class="comment">//  number of mip levels</span>
00442                                                             0,                      <span class="comment">//  texture usage</span>
00443                                                             D3DFMT_UNKNOWN,         <span class="comment">//  color format</span>
00444                                                             D3DPOOL_MANAGED,        <span class="comment">//  memory pool</span>
00445                                                             D3DX_DEFAULT,           <span class="comment">//  image filter </span>
00446                                                             D3DX_DEFAULT,           <span class="comment">//  mip filter</span>
00447                                                             0,                      <span class="comment">//  disable color key</span>
00448                                                             NULL,                   <span class="comment">//  don't care about image info</span>
00449                                                             NULL,                   <span class="comment">//  no palette</span>
00450                                                             &amp;m_pVolTexture              
00451                                                             );
00452         m_pBaseTexture  = m_pVolTexture;
00453     }
00454     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (info.ResourceType == D3DRTYPE_CUBETEXTURE)
00455     {
00456         m_Type = ttCubeMap;
00457         hres = D3DXCreateCubeTextureFromFileInMemoryEx( m_pDevice, 
00458                                                         pBuf, nBytes,
00459                                                         D3DX_DEFAULT,           <span class="comment">//  width</span>
00460                                                         D3DX_DEFAULT,           <span class="comment">//  number of mip levels</span>
00461                                                         0,                      <span class="comment">//  texture usage</span>
00462                                                         D3DFMT_UNKNOWN,         <span class="comment">//  color format</span>
00463                                                         D3DPOOL_MANAGED,        <span class="comment">//  memory pool</span>
00464                                                         D3DX_DEFAULT,           <span class="comment">//  image filter </span>
00465                                                         D3DX_DEFAULT,           <span class="comment">//  mip filter</span>
00466                                                         0,                      <span class="comment">//  disable color key</span>
00467                                                         NULL,                   <span class="comment">//  don't care about image info</span>
00468                                                         NULL,                   <span class="comment">//  no palette</span>
00469                                                         &amp;m_pCubeTexture             
00470                                                         );
00471         m_pBaseTexture  = m_pCubeTexture;
00472     }
00473 
00474 
00475     <span class="keywordflow">if</span> (hres != S_OK || !m_pBaseTexture)
00476     {
00477         Log.Warning( <span class="stringliteral">"Couldn't create texture from memory data: %s"</span>, m_Name.c_str() );
00478         <span class="keywordflow">return</span> <span class="keyword">false</span>;
00479     }
00480 
00481     <span class="comment">//  get info into texture description</span>
00482     <span class="keywordflow">if</span> (m_pTexture) 
00483     {
00484         D3DSURFACE_DESC sdesc;
00485         DX_CHK( m_pTexture-&gt;GetLevelDesc( 0, &amp;sdesc ) );
00486         m_Type          = tt2D;
00487         m_NMipMaps      = m_pTexture-&gt;GetLevelCount();
00488         m_MemoryPool    = ConvertMemoryPool( sdesc.Pool );
00489         m_ColorFormat   = ConvertColorFormat( sdesc.Format );
00490         m_Width         = sdesc.Width;
00491         m_Height        = sdesc.Height;
00492         <span class="keywordtype">bool</span> goodX = <span class="keyword">false</span>;
00493         <span class="keywordtype">bool</span> goodY = <span class="keyword">false</span>;
00494         <span class="keywordflow">for</span>(<span class="keywordtype">int</span> i=0;i&lt;12;i++){
00495             <span class="keywordtype">int</span> sz=1&lt;&lt;i;
00496             <span class="keywordflow">if</span>(m_Width==sz)goodX = <span class="keyword">true</span>;
00497             <span class="keywordflow">if</span>(m_Height==sz)goodY = <span class="keyword">true</span>;
00498         }
00499         <span class="keywordflow">if</span>(!(goodX &amp;&amp; goodY) ){
00500             Log.Warning(<span class="stringliteral">"Texture &lt;%s&gt; has an incorrect size: %dx%d"</span>,m_Name.c_str(),m_Width,m_Height);
00501         }
00502     }
00503     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_pCubeTexture) 
00504     {
00505         D3DSURFACE_DESC sdesc;
00506         DX_CHK( m_pCubeTexture-&gt;GetLevelDesc(  0, &amp;sdesc ) );
00507         m_Type          = ttCubeMap;
00508         m_NMipMaps      = m_pCubeTexture-&gt;GetLevelCount();
00509         m_MemoryPool    = ConvertMemoryPool( sdesc.Pool );
00510         m_ColorFormat   = ConvertColorFormat( sdesc.Format );
00511         m_Width         = sdesc.Width;
00512         m_Height        = sdesc.Height;
00513     }
00514     <span class="keywordflow">else</span> <span class="keywordflow">if</span> (m_pVolTexture) 
00515     {
00516         D3DVOLUME_DESC vdesc;
00517         DX_CHK( m_pVolTexture-&gt;GetLevelDesc( 0, &amp;vdesc ) );
00518         m_Type          = tt3D;
00519         m_NMipMaps      = m_pVolTexture-&gt;GetLevelCount();
00520         m_MemoryPool    = ConvertMemoryPool( vdesc.Pool );
00521         m_ColorFormat   = ConvertColorFormat( vdesc.Format );
00522         m_Width         = vdesc.Width;
00523         m_Height        = vdesc.Height;
00524     }
00525     <span class="keywordflow">else</span> <span class="keywordflow">return</span> <span class="keyword">false</span>;
00526 
00527     m_DSFormat      = dsfNone;
00528     m_bRenderTarget = <span class="keyword">false</span>;
00529 
00530     <span class="keywordflow">return</span> <span class="keyword">true</span>;
00531 } <span class="comment">// TextureDX9::LoadFromMemory</span>
00532 
00533 <span class="keywordtype">void</span> TextureDX9::LoadHeader()
00534 {
00535     _chdir( m_SearchPath.c_str() );
00536     <span class="keywordtype">int</span> size = 0;
00537     <span class="keywordtype">int</span> resID = IRM-&gt;FindResource( m_Name.c_str() );
00538     IRM-&gt;BindResource( resID, <span class="keyword">this</span> );
00539     BYTE* pData = IRM-&gt;LockData( resID, size );
00540 
00541     <span class="keywordflow">if</span> (resID != -1) 
00542     {
00543         FilePath path( IRM-&gt;GetFullPath( resID ) );
00544         path.SetFileName( <span class="stringliteral">""</span> );
00545         path.SetExt( <span class="stringliteral">""</span> );
00546         m_SearchPath = path;
00547     }
00548 
00549     HRESULT hres = S_OK;
00550     D3DXIMAGE_INFO info;
00551     hres = D3DXGetImageInfoFromFileInMemory( pData, size, &amp;info );
00552     <span class="keywordflow">if</span> (hres == S_OK)
00553     {
00554         m_Width     = info.Width;
00555         m_Height    = info.Height;
00556     }
00557 
00558     IRM-&gt;UnlockData( resID );
00559     _chdir( IRM-&gt;GetHomeDirectory() );
00560 } <span class="comment">// TextureDX9::LoadHeader</span>
00561 
00562 <span class="keywordtype">int</span> TextureDX9::GetSize()<span class="keyword"> const</span>
00563 <span class="keyword"></span>{
00564     <span class="keywordflow">if</span> (!m_pBaseTexture) <span class="keywordflow">return</span> 0;
00565     <span class="keywordtype">int</span> nPix = m_Width*m_Height;
00566     <span class="keywordflow">return</span> ColorValue::GetBitmapSize( m_ColorFormat, nPix ); 
00567 } <span class="comment">// TextureDX9::GetSize</span>
</pre></div><hr><address style="align: right;"><small>
Generated on Tue Jun 13 11:14:33 2006 for gRenderDX9 by <a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 width=110 height=53>
</a> 1.3.1 using KingsTools</small></address>
</body>
</html>
